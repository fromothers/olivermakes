<script src="{{ site.script_url }}/site.js" defer></script>

<link rel="prerender" href="{{ site.url }}">
<link rel="preconnect" href="{{ site.imgix_url }}">

{% if page.collection == 'photos' and page.longitude and page.latitude %}
<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.25.1/mapbox-gl.js"defer></script>
<link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.25.1/mapbox-gl.css" rel="stylesheet" />

<script>
// all of this runs conditionally only if page location parameters are set
document.addEventListener('DOMContentLoaded', contentLoaded, false);

function contentLoaded () {
  // authorization key set in prod.yml
  mapboxgl.accessToken = '{{ site.mapbox.key }}';

  // long and lat pulled from front matter
  var location = [{{ page.longitude }}, {{ page.latitude }}]

  var map = new mapboxgl.Map({
    container: 'map',
    // style set in prod.yml
    style: '{{ site.mapbox.style }}',
    // optional zoom value set in front matter
    zoom: {% if page.zoom %}{{ page.zoom }}{% else %}12{% endif %},
    center: location,
    // attribution control is set in prod.yml
    attributionControl: false,
    scrollZoom: false
  });

  // add mapbox controls
  map.addControl(new mapboxgl.Navigation());
  map.addControl(new mapboxgl.Scale({
    position: 'top-left',
    maxWidth: 100,
    unit: 'metric'
  }));

  // disable scroll-zooming unless the user hovers for more than 2 seconds on the map
  map.on('mousemove', function (e) {
    setTimeout(function(){
      map.scrollZoom.enable();
    },
    2400);
  });

  var popupParameters = {
    closeButton: false,
    offset: [12, -2]
  }

  // set popup positioning and location from front matter
  var popup = new mapboxgl.Popup(popupParameters)
    .setLngLat(location)
    .setText('{{ page.location }}');

  // attach popup to the marker
  var marker = new mapboxgl.Marker()
    .setLngLat(location)
    .setPopup(popup)
    .addTo(map);
}

</script>
{% endif %}
